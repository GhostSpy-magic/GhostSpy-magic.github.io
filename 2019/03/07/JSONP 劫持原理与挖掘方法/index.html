<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>JSONP 劫持原理与挖掘方法 | K0rz3n's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JSONP 劫持原理与挖掘方法</h1><a id="logo" href="/.">K0rz3n's Blog</a><p class="description">Shell-is-Only-the-Beginning</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/rss/"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JSONP 劫持原理与挖掘方法</h1><div class="post-meta">Mar 7, 2019<span> | </span><span class="category"><a href="/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="0X00-前言"><a href="#0X00-前言" class="headerlink" title="0X00 前言"></a><strong>0X00 前言</strong></h2><p>最近打算看一些前端方面的东西，琢磨着从哪里开始看起，正好想到之前我还有一篇 <a href="https://www.k0rz3n.com/2018/06/05/%E7%94%B1%E6%B5%85%E5%85%A5%E6%B7%B1%E7%90%86%E8%A7%A3JSONP%E5%B9%B6%E6%8B%93%E5%B1%95/">由浅入深理解 jsonp 并拓展</a> 这样的文章，主要介绍的是 jsonp 的概念，利用思路还没有讲，于是干脆就接着写这个话题吧。</p>
<h2 id="0X01-什么是-JSONP-劫持"><a href="#0X01-什么是-JSONP-劫持" class="headerlink" title="0X01 什么是 JSONP 劫持"></a><strong>0X01 什么是 JSONP 劫持</strong></h2><p>由于之前的那篇文章已经详细介绍过 jsonp 的工作原理，所以这里就不再详细介绍原理了，就简单的说一下：</p>
<p><strong>JSONP</strong> 就是为了跨域<strong>获取资源</strong>而产生的一种<strong>非官方</strong>的技术手段(官方的有 CORS 和 postMessage),它利用的是 script 标签的 src 属性不受同源策略影响的特性，</p>
<a id="more"></a>
<p>那么<strong>劫持</strong>又是怎么回事呢？其实我们在学安全的过程中对劫持这个词可以说是一点也不陌生，我们遇到过很多的劫持的攻击方法，比如：dns 劫持、点击劫持、cookie劫持等等，也正如劫持这个词的含义：“拦截挟持”，dns 劫持就是把 dns 的解析截获然后篡改，点击劫持就是截获你的鼠标的点击动作，在用户不知情的情况下点击攻击者指定的东西，cookie 劫持就是获取用户的 cookie，然后可以进一步伪造身份，那么同样， jsonp 劫持就是攻击者获取了本应该传给网站其他接口的数据</p>
<h2 id="0X02-JSONP-漏洞的利用过程及危害"><a href="#0X02-JSONP-漏洞的利用过程及危害" class="headerlink" title="0X02 JSONP 漏洞的利用过程及危害"></a><strong>0X02 JSONP 漏洞的利用过程及危害</strong></h2><p>通过JSONP技术可以实现数据的跨域访问，必然会产生安全问题，如果网站B对网站A的JSONP请求没有进行安全检查直接返回数据，则网站B 便存在JSONP 漏洞，网站A 利用JSONP漏洞能够获取用户在网站B上的数据。</p>
<h3 id="1-JSONP漏洞利用过程如下："><a href="#1-JSONP漏洞利用过程如下：" class="headerlink" title="1.JSONP漏洞利用过程如下："></a><strong>1.JSONP漏洞利用过程如下：</strong></h3><p>1）用户在网站B 注册并登录，网站B 包含了用户的id，name，email等信息；<br>2）用户通过浏览器向网站A发出URL请求；<br>3）网站A向用户返回响应页面，响应页面中注册了JavaScript的回调函数和向网站B请求的script标签，示例代码如下：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
function Callback(result)
{
    alert(result.name);
}
&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;http://B.com/user?jsonp=Callback&quot;&gt;&lt;/script&gt;
</code></pre><p>4）用户收到响应，解析JS代码，将回调函数作为参数向网站B发出请求；<br>5）网站B接收到请求后，解析请求的URL，以JSON 格式生成请求需要的数据，将封装的包含用户信息的JSON数据作为回调函数的参数返回给浏览器，网站B返回的数据实例如下：</p>
<pre><code>Callback({&quot;id&quot;:1,&quot;name&quot;:&quot;test&quot;,&quot;email&quot;:&quot;test@test.com&quot;})。
</code></pre><p>6）网站B数据返回后，浏览器则自动执行Callback函数对步骤4返回的JSON格式数据进行处理，通过alert弹窗展示了用户在网站B的注册信息。另外也可将JSON数据回传到网站A的服务器，这样网站A利用网站B的JSONP漏洞便获取到了用户在网站B注册的信息。</p>
<h3 id="2-JSONP-漏洞利用过程示意图"><a href="#2-JSONP-漏洞利用过程示意图" class="headerlink" title="2.JSONP 漏洞利用过程示意图"></a><strong>2.JSONP 漏洞利用过程示意图</strong></h3><p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%951.png" alt="此处输入图片的描述"></p>
<h3 id="3-JSONP-劫持漏洞的危害"><a href="#3-JSONP-劫持漏洞的危害" class="headerlink" title="3.JSONP 劫持漏洞的危害"></a><strong>3.JSONP 劫持漏洞的危害</strong></h3><p><strong>JSONP是一种敏感信息泄露的漏洞</strong>，经过攻击者巧妙而持久地利用，会对企业和用户造成巨大的危害。攻击者通过巧妙设计一个网站，<strong>网站中包含其他网站的JSONP漏洞利用代码</strong>，将链接通过邮件等形式推送给受害人，<strong>如果受害者点击了链接，则攻击者便可以获取受害者的个人的信息，如邮箱、姓名、手机等信息，</strong>这些信息可以被违法犯罪分子用作“精准诈骗”。对方掌握的个人信息越多，越容易取得受害人的信任，诈骗活动越容易成功，给受害人带来的财产损失以及社会危害也就越大。</p>
<h2 id="J0X03-SOP-漏洞的挖掘思路"><a href="#J0X03-SOP-漏洞的挖掘思路" class="headerlink" title="J0X03 SOP 漏洞的挖掘思路"></a><strong>J0X03 SOP 漏洞的挖掘思路</strong></h2><p>这里我采用chrome浏览器的调试窗口进行挖掘weibo.com中存在的漏洞(测试之前需要登录一下，因为我们需要检测是不是会有敏感信息泄露)</p>
<p>首先把Preserve log选项勾上，这样用来防止页面刷新跳转的时候访问记录被重置，也方便我们进行下一步的筛选。</p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%952.png" alt="此处输入图片的描述"></p>
<p>然后 F5 刷新，进入 NetWork 标签 ，CTRL+F 查找一些关键词 如 callback json jsonp email</p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%953.png" alt="此处输入图片的描述"></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%954.png" alt="此处输入图片的描述"></p>
<p>然后我们需要人工确认这个请求的返回值是否有泄露用户的敏感信息，并且能被不同的域的页面去请求获取，这里以上面查找到的 jsonp 为例</p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%955.png" alt="此处输入图片的描述"></p>
<p>发现并不是什么很有价值的信息，再来看看能不能被不同的域的页面请求到(也就是测试一下服务器端有没有对其验证请求来源）</p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%956.png" alt="此处输入图片的描述"></p>
<p>发现换成了别的浏览器还是能检测到，说明验证的来源有些问题</p>
<blockquote>
<p><strong>注意：</strong></p>
<p>上面的测试只是我为了简单的演示整个流程，所以在测试前我并没有登录，因此，上面的测试并不能说明漏洞存在</p>
</blockquote>
<p><strong>当然，这种人工的低效的检测方式我们完全可以将其变成主动或者被动的扫描器实现，那样效率会高得多</strong></p>
<p>自动化测试工具Selenium + Proxy + 验证脚本</p>
<p>(1)Selenium：可用于自动化对网页进行测试，“到处”点击按钮、超链接，以期待测试更多的接口；<br>(2)Proxy：用于代理所有的请求，过滤出所有包含敏感信息的JSONP请求，并记录下HTTP请求；<br>(3)验证脚本：使用上述的HTTP请求，剔除referer字段，再次发出请求，测试返回结果中，是否仍包敏感信息，如果有敏感信息，说明这个接口就是我们要找的！</p>
<h2 id="0X04-JSONP-漏洞利用技巧"><a href="#0X04-JSONP-漏洞利用技巧" class="headerlink" title="0X04 JSONP 漏洞利用技巧"></a><strong>0X04 JSONP 漏洞利用技巧</strong></h2><h3 id="1-利用技巧"><a href="#1-利用技巧" class="headerlink" title="1.利用技巧"></a><strong>1.利用技巧</strong></h3><p>JSONP 漏洞主要被攻击者用来在受害者不知不觉中窃取他们的隐私数据，常常被一些 APT 组织采用进行信息收集和钓鱼的工作(<a href="https://www.freebuf.com/articles/web/70025.html" target="_blank" rel="noopener">水坑攻击</a>)，下面的一个例子就可以说是在模拟水坑攻击</p>
<p>当我们发现信息泄露的 jsonp 接口以后我们要做的就是在自己的网站上写一个脚本，然后引诱受害者去访问这个网站，一旦访问了这个网站，脚本就会自动运行，就会想这个接口请求用户的敏感数据，并传送到攻击者的服务器上</p>
<pre><code>$.ajax({
    url: &apos;https://api.weibo.com/2/{隐藏了哦}&apos;,
    type: &apos;get&apos;,
    dataType: &apos;jsonp&apos;,
}).done(function(json){
    var id = json[&quot;data&quot;][&quot;id&quot;];
    var screen_name = json[&quot;data&quot;][&quot;screen_name&quot;];
    var profile_image_url = json[&quot;data&quot;][&quot;profile_image_url&quot;];

    var post_data = &quot;&quot;;
    post_data += &quot;id=&quot; + id + &quot;&amp;amp;&quot;;
    post_data += &quot;screen_name=&quot; + screen_name + &quot;&amp;amp;&quot;;
    post_data += &quot;profile_image_url=&quot; + encodeURIComponent(profile_image_url);
    console.log(post_data);
    // 发送到我的服务器上
}).fail(function() {});
</code></pre><p>这样就能收到大量用户的敏感信息了</p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%957.png" alt="此处输入图片的描述"></p>
<p>上述相关代码被一个师傅放在了 github 上，<a href="https://github.com/qiaofei32/jsonp_info_leak" target="_blank" rel="noopener">地址</a></p>
<h3 id="2-相关扩展"><a href="#2-相关扩展" class="headerlink" title="2.相关扩展"></a><strong>2.相关扩展</strong></h3><p>(1)既然是窃取敏感信息，那么敏感信息除了一些 email 手机号 用户名等还有什么呢？没错，甚至可以是 CSRF Token 信息，有时候在 CSRF token 获取不到但是又找不到 XSS 的攻击点的时候不妨考虑一下 jsonp 劫持,看看会不会有惊喜</p>
<p>(2)还有一点，你有没有觉得这个攻击方式有点类似于 CSRF ，是的，的确很像，因此这也就引出了非常类似的修复方案。</p>
<h2 id="0X05-防护方案"><a href="#0X05-防护方案" class="headerlink" title="0X05 防护方案"></a><strong>0X05 防护方案</strong></h2><p>1、严格安全的实现 CSRF 方式调用 JSON 文件：限制 Referer 、部署一次性 Token 等。<br>2、严格安装 JSON 格式标准输出 Content-Type 及编码（ Content-Type : application/json; charset=utf-8 ）。<br>3、严格过滤 callback 函数名及 JSON 里数据的输出。<br>4、严格限制对 JSONP 输出 callback 函数名的长度(如防御上面 flash 输出的方法)。<br>5、其他一些比较“猥琐”的方法：如在 Callback 输出之前加入其他字符(如：/**/、回车换行)这样不影响 JSON 文件加载，又能一定程度预防其他文件格式的输出。还比如 Gmail 早起使用 AJAX 的方式获取 JSON ，听过在输出 JSON 之前加入 while(1) ;这样的代码来防止 JS 远程调用。</p>
<h2 id="0X06-参考链接"><a href="#0X06-参考链接" class="headerlink" title="0X06 参考链接"></a><strong>0X06 参考链接</strong></h2><p><a href="http://www.mottoin.com/tech/123337.html" target="_blank" rel="noopener">http://www.mottoin.com/tech/123337.html</a><br><a href="https://www.anquanke.com/post/id/97671" target="_blank" rel="noopener">https://www.anquanke.com/post/id/97671</a><br><a href="https://xiaix.me/fan-yi-wa-jue-tong-yuan-fang-fa-zhi-xing-lou-dong-same-origin-method-execution/" target="_blank" rel="noopener">https://xiaix.me/fan-yi-wa-jue-tong-yuan-fang-fa-zhi-xing-lou-dong-same-origin-method-execution/</a><br><a href="https://wooyun.js.org/drops/JS%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%EF%BC%9A%E4%B8%8D%E5%AE%B9%E5%BF%BD%E8%A7%86%E7%9A%84WEB%E6%BC%8F%E6%B4%9E.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/JS%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%EF%BC%9A%E4%B8%8D%E5%AE%B9%E5%BF%BD%E8%A7%86%E7%9A%84WEB%E6%BC%8F%E6%B4%9E.html</a><br><a href="https://www.infosec-wiki.com/?p=455211" target="_blank" rel="noopener">https://www.infosec-wiki.com/?p=455211</a><br><a href="https://www.cnblogs.com/52php/p/5677775.html" target="_blank" rel="noopener">https://www.cnblogs.com/52php/p/5677775.html</a><br><a href="http://www.91ri.org/13407.html" target="_blank" rel="noopener">http://www.91ri.org/13407.html</a><br><a href="https://www.freebuf.com/articles/web/70025.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/70025.html</a></p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.4" async></script><a data-url="https://www.k0rz3n.com/2019/03/07/JSONP 劫持原理与挖掘方法/" data-id="cjv7v4t6s002pvgv8lwt6ug13" class="article-share-link">Aktie</a><div class="tags"><a href="/tags/前端/">前端</a></div><div class="post-nav"><a href="/2019/03/07/论白名单的不安全性与内容安全政策的未来(半翻译有删增)/" class="pre">论白名单的不安全性与内容安全策略的未来(半机翻有删增)</a><a href="/2019/03/05/爬虫爬取动态网页的三种方式简介/" class="next">爬虫爬取动态网页的三种方式简介</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="side_toc"><div style="position:fixed" class="toc-article"><div class="toc-title">Inhalte</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0X00-前言"><span class="toc-number">1.</span> <span class="toc-text">0X00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X01-什么是-JSONP-劫持"><span class="toc-number">2.</span> <span class="toc-text">0X01 什么是 JSONP 劫持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X02-JSONP-漏洞的利用过程及危害"><span class="toc-number">3.</span> <span class="toc-text">0X02 JSONP 漏洞的利用过程及危害</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-JSONP漏洞利用过程如下："><span class="toc-number">3.1.</span> <span class="toc-text">1.JSONP漏洞利用过程如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JSONP-漏洞利用过程示意图"><span class="toc-number">3.2.</span> <span class="toc-text">2.JSONP 漏洞利用过程示意图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-JSONP-劫持漏洞的危害"><span class="toc-number">3.3.</span> <span class="toc-text">3.JSONP 劫持漏洞的危害</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#J0X03-SOP-漏洞的挖掘思路"><span class="toc-number">4.</span> <span class="toc-text">J0X03 SOP 漏洞的挖掘思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X04-JSONP-漏洞利用技巧"><span class="toc-number">5.</span> <span class="toc-text">0X04 JSONP 漏洞利用技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-利用技巧"><span class="toc-number">5.1.</span> <span class="toc-text">1.利用技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-相关扩展"><span class="toc-number">5.2.</span> <span class="toc-text">2.相关扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X05-防护方案"><span class="toc-number">6.</span> <span class="toc-text">0X05 防护方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0X06-参考链接"><span class="toc-number">7.</span> <span class="toc-text">0X06 参考链接</span></a></li></ol></div></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">K0rz3n's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/byoungd/pure"> Pure Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/byoungd"> byoungd.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>