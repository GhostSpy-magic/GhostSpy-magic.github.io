<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content>
    <meta name="author" content="John Doe">
    <meta name="keywords" content>
    <title>渗透测试小技巧一：寻找EXP ~ Hexo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>Hexo</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/about/">About</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("https://i.imgur.com/oADD1Ip.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">渗透测试小技巧一：寻找EXP</p>
            <br>
            
            <p>Sunday, January 27th 2019, 4:14 am</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h2 id="0X00-前言"><a href="#0X00-前言" class="headerlink" title="0X00 前言:"></a><strong>0X00 前言:</strong></h2><p>简单总结一下渗透过程中寻找 EXP 的一些方法，还顺便为 windows 下未打的漏洞补丁的寻找写了一个小工具，希望师傅们多多支持！</p>
<h2 id="0X01-Windows-下寻找可用的-exp"><a href="#0X01-Windows-下寻找可用的-exp" class="headerlink" title="0X01 Windows 下寻找可用的 exp"></a><strong>0X01 Windows 下寻找可用的 exp</strong></h2><h3 id="1-简单的科普："><a href="#1-简单的科普：" class="headerlink" title="1.简单的科普："></a><strong>1.简单的科普：</strong></h3><p>拿到一台 windows 主机，能执行命令了，那么如果想提权的话最好的方式就是利用现有的 exp 直接打，肯定是要使用 systeminfo 这个命令查看系统已打补丁,但是寻找可能存在的特权提升漏洞是一个比较麻烦的过程，我们首先需要知道当前的特权提升洞的 KB 列表，然后再与系统systeminfo 中的 KB 列表进行对比(<strong>KB是微软对补丁的命名方式，是Knowledge Base(知识库)的简称，其指的是某个补丁对应微软知识库中哪一篇文章。例如KB888111，就是对应知识库中888111号文章</strong>)。</p>
<a id="more"></a>
<p><strong>可以参考的网站如下：这里面列出了比较新的安全公告</strong></p>
<blockquote>
<p><a href="https://docs.microsoft.com/zh-cn/security-updates/" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/security-updates/</a></p>
</blockquote>
<p><strong>如下图所示：</strong></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/%E5%AF%BB%E6%89%BE%20exp1.png" alt="此处输入图片的描述"></p>
<p>MS17-023 对应的补丁就是 KB4014329 ，说明这个来源于 Microsoft 知识库文章 4014329。</p>
<p>当然这样似乎还是不是很方便查找，于是我又找到了一个文件</p>
<blockquote>
<p><strong>链接如下：</strong></p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=36982" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=36982</a></p>
</blockquote>
<p>这个文件整理的比较全了，可以说是网页版的集合</p>
<p><strong>如下图：</strong></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/%E5%AF%BB%E6%89%BE%20exp2.png" alt="此处输入图片的描述"></p>
<p>但是这个文件的冗余还是非常大的，因为特权提升漏洞相对来讲并不是很多，这里面列出的很多代码执行的洞实际上我们并不需要，所以到这一步其实有两种思路，一种就是按照上面的方法写脚本或者怎么样找到补丁列表中有但是系统没有的特权提升补丁，还有一种就是反向思维，找到系统需要更新的补丁，然后反推哪些漏洞存在。</p>
<h3 id="2-进入正题"><a href="#2-进入正题" class="headerlink" title="2.进入正题"></a><strong>2.进入正题</strong></h3><h4 id="先说思路一："><a href="#先说思路一：" class="headerlink" title="先说思路一："></a><strong>先说思路一：</strong></h4><p>这里不得不提到几个非常好的项目：</p>
<blockquote>
<p><a href="https://github.com/SecWiki/windows-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/windows-kernel-exploits</a><br><a href="https://github.com/WindowsExploits/Exploits" target="_blank" rel="noopener">https://github.com/WindowsExploits/Exploits</a><br><a href="https://github.com/AusJock/Privilege-Escalation" target="_blank" rel="noopener">https://github.com/AusJock/Privilege-Escalation</a></p>
</blockquote>
<p><strong>方法一：</strong></p>
<p>重点关注第一个吧，这里面有一个比较好的工具 <strong>win-exp-suggester</strong> 这也是我一直想写的，但是发现人家也已经写了就直接拿来用了，原理就是我上面说的第一种方法，根据上面的那个 xslx 文件中的信息与 systeminfo 进行比较。</p>
<p><strong>1）首先更新一下数据库</strong></p>
<pre><code>$ python windows-exploit-suggester.py --update
[*] initiating winsploit version 3.3...
[+] writing to file 2019-01-22-mssb.xls
[*] done
</code></pre><p><strong>2)安装必要的依赖</strong></p>
<pre><code> pip install xlrd --upgrade
Collecting xlrd
  Downloading https://files.pythonhosted.org/packages/b0/16/63576a1a001752e34bf8ea62e367997530dc553b689356b9879339cf45a4/xlrd-1.2.0-py2.py3-none-any.whl (103kB)
    100% |████████████████████████████████| 112kB 84kB/s
Installing collected packages: xlrd
Successfully installed xlrd-1.2.0
</code></pre><p><strong>3)将 sysinfo.txt 作为参数传给脚本</strong></p>
<pre><code>$ python windows-exploit-suggester.py --database 2019-01-22-mssb.xls --systeminfo sysinfo.txt
[*] initiating winsploit version 3.3...
[*] database file detected as xls or xlsx based on extension
[*] attempting to read from the systeminfo input file
[+] systeminfo input file read successfully (GB2312)
[*] querying database file for potential vulnerabilities
[*] comparing the 3 hotfix(es) against the 160 potential bulletins(s) with a database of 137 known exploits
[*] there are now 160 remaining vulns
[+] [E] exploitdb PoC, [M] Metasploit module, [*] missing bulletin
[+] windows version identified as &apos;Windows 10 64-bit&apos;
[*]
[E] MS16-135: Security Update for Windows Kernel-Mode Drivers (3199135) - Important
[*]   https://www.exploit-db.com/exploits/40745/ -- Microsoft Windows Kernel - win32k Denial of Service (MS16-135)
[*]   https://www.exploit-db.com/exploits/41015/ -- Microsoft Windows Kernel - &apos;win32k.sys&apos; &apos;NtSetWindowLongPtr&apos; Privilege Escalation (MS16-135) (2)
[*]   https://github.com/tinysec/public/tree/master/CVE-2016-7255
</code></pre><p>当然这里面有些实际上是不准确的，因为有些补丁在系统一开始就已经被修复了，于是在 systeminfo 里面不会显示打过这个补丁，但是漏洞实际上并不存在。</p>
<p><strong>方法二：</strong></p>
<p>那么除了这个方法以外，我后来还发现了一个网站也能起到类似的作用 <a href="http://blog.neargle.com/win-powerup-exp-indexmyqcloud.com/%E5%AF%BB%E6%89%BE%20exp2.png" target="_blank" rel="noopener">传送门</a></p>
<p><strong>方法三：</strong></p>
<p>我们可以直接利用 bat 脚本，在收集过可能存在的 KBxxxx 以后使用下面的脚本(收集 KBxxx 其实还是在第一个项目里) ，然后可以使用类似下面的脚本</p>
<pre><code>systeminfo &gt; sysinfo.txt&amp;(for %i in ( KB977165 KB2160329 KB2503665 KB2592799
KB2707511 KB2829361 KB2850851 KB3000061 KB3045171 KB3077657 KB3079904
KB3134228 KB3143141 KB3141780 ) do @type sysinfo.txt|@find /i &quot;%i&quot;|| @echo
%i you can fuck)&amp;del /f /q /a sysinfo.txt
</code></pre><p>这个脚本实际上就是查看 sysinfo 中有没有列出来的这些 KB （当然脚本使用条件就是在可写目录运行）</p>
<h4 id="再来看思路二"><a href="#再来看思路二" class="headerlink" title="再来看思路二:"></a><strong>再来看思路二:</strong></h4><p>思路二的方法实际上相当于我们使用系统的检查更新的功能，只不过是我么需要在命令行运行罢了，这里要用到 WUA API (Windows Update Agent API) ，官网对应的地址在 <a href="https://docs.microsoft.com/zh-cn/windows/desktop/Wua_Sdk/portal-client" target="_blank" rel="noopener">这里</a> ，网上看到有大佬用 C++ 结合 windows 的 COM 组件的方法写的一个 demo ，我觉得简单的优化完善一下就能成为一个比较方便快捷的工具，不仅仅可以用来 hack ，作为正常的检查系统更新情况来讲也是非常不错的。</p>
<p>我修改完善后的项目放在了我的 github 上，地址如下<strong>（欢迎师傅们提 issue 和 star)</strong></p>
<blockquote>
<p><a href="https://github.com/K0rz3n/PatchesTester" target="_blank" rel="noopener">https://github.com/K0rz3n/PatchesTester</a></p>
</blockquote>
<p><strong>运行效果图：</strong></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/%E5%AF%BB%E6%89%BE%20exp3.png" alt="此处输入图片的描述"></p>
<p><strong>结果如下：</strong></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/%E5%AF%BB%E6%89%BE%20exp4.png" alt="此处输入图片的描述"></p>
<p>因为这个工具是按照严重等级从高到底排序的，所以还是比较方便的！</p>
<h2 id="0X02-Linux-下寻找可用的-exp"><a href="#0X02-Linux-下寻找可用的-exp" class="headerlink" title="0X02 Linux 下寻找可用的 exp"></a><strong>0X02 Linux 下寻找可用的 exp</strong></h2><p>相比于 Windows， Linux 的漏洞信息相对简单一些，但是还是要推荐这个项目</p>
<blockquote>
<p><a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/linux-kernel-exploits</a></p>
</blockquote>
<p>还有下面这个工具</p>
<blockquote>
<p><a href="https://github.com/jondonas/linux-exploit-suggester-2" target="_blank" rel="noopener">https://github.com/jondonas/linux-exploit-suggester-2</a></p>
</blockquote>
<p><strong>默认运行即可</strong></p>
<pre><code>root@K0rz3n:~# ./linux-exploit-suggester-2.pl

  #############################
    Linux Exploit Suggester 2
  #############################

  Local Kernel: 4.15.0
  Searching among 73 exploits...

  Possible Exploits:
</code></pre><blockquote>
<p>另外补充其他的两个项目：</p>
<p><a href="https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack/" target="_blank" rel="noopener">https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack/</a><br><a href="https://github.com/xairy/kernel-exploits" target="_blank" rel="noopener">https://github.com/xairy/kernel-exploits</a></p>
</blockquote>
<h2 id="0X03-总结"><a href="#0X03-总结" class="headerlink" title="0X03 总结"></a><strong>0X03 总结</strong></h2><p>作为渗透测试技巧的第一篇，内容还是比较简单的，日后有空会慢慢更新该系列的更多的文章。</p>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;渗透测试 技巧</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
                    <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>